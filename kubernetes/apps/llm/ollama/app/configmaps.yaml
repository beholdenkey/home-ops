---
apiVersion: v1
kind: ConfigMap
metadata:
  name: ollama-models
data:
  models.txt: |
    zongwei/gemma3-translator:4b
    LayOnGGUF/llama3-stheno:8b
    qwen3:4b

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: ollama-sync-script
data:
  sync-models.sh: |-
    #!/bin/sh
    set -eu

    echo "üü¢ Starting temporary Ollama server..."

    # Ensure model directory exists (works for both /models and default locations)
    : "${OLLAMA_MODELS:=/root/.ollama/models}"
    mkdir -p "$OLLAMA_MODELS"

    # Start server in background
    ollama serve >/tmp/ollama-serve.log 2>&1 &
    SERVE_PID="$!"

    cleanup() {
      echo "üßπ Stopping temporary Ollama server (pid=$SERVE_PID)..."
      kill "$SERVE_PID" 2>/dev/null || true
      wait "$SERVE_PID" 2>/dev/null || true
    }
    trap cleanup EXIT INT TERM

    # Wait until Ollama responds
    echo "‚è≥ Waiting for Ollama to start..."
    i=0
    while :; do
      if ollama list >/dev/null 2>&1; then
        echo "‚úÖ Ollama is up!"
        break
      fi
      i=$((i+1))
      if [ "$i" -ge 60 ]; then
        echo "‚ùå Ollama did not become ready. Last logs:"
        tail -n 200 /tmp/ollama-serve.log || true
        exit 1
      fi
      sleep 1
    done

    MODELS_FILE="/config/models.txt"
    if [ ! -f "$MODELS_FILE" ]; then
      echo "‚ùå Models file not found at $MODELS_FILE"
      exit 1
    fi

    # Read desired models (one per line), ignore blanks/comments
    DESIRED="$(grep -v '^[[:space:]]*$' "$MODELS_FILE" | grep -v '^[[:space:]]*#' || true)"

    echo "üìú Desired models:"
    echo "$DESIRED" | sed 's/^/  - /'

    # Get installed models (skip header)
    INSTALLED="$(ollama list | awk 'NR>1 {print $1}')"

    # Pull missing models
    for model in $DESIRED; do
      if echo "$INSTALLED" | grep -qx "$model"; then
        echo "‚úî $model already installed"
      else
        echo "‚¨á Pulling $model..."
        ollama pull "$model"
      fi
    done

    # Refresh installed list after pulls
    INSTALLED="$(ollama list | awk 'NR>1 {print $1}')"

    # Optional: remove extra models not in desired list
    # Enable by setting env REMOVE_EXTRA_MODELS=true on the initContainer.
    if [ "${REMOVE_EXTRA_MODELS:-false}" = "true" ]; then
      for model in $INSTALLED; do
        echo "$DESIRED" | grep -qx "$model" && continue
        echo "üóë Removing $model (not in desired list)"
        ollama rm "$model" || true
      done
    else
      echo "‚ÑπÔ∏è Skipping removal of extra models (set REMOVE_EXTRA_MODELS=true to enable)."
    fi

    echo "‚úÖ Model sync complete."
