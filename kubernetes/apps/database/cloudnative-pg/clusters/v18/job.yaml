---
apiVersion: batch/v1
kind: Job
metadata:
  name: immich-initdb
spec:
  backoffLimit: 0
  ttlSecondsAfterFinished: 3600
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: init
          image: ghcr.io/home-operations/postgres-init:18.1.0
          envFrom:
            - secretRef:
                name: postgres-immich-init
---
apiVersion: batch/v1
kind: Job
metadata:
  name: immich-db-extensions
spec:
  backoffLimit: 0
  ttlSecondsAfterFinished: 3600
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: extensions
          image: postgres:18
          envFrom:
            - secretRef:
                name: postgres-immich-init
          command:
            - "/bin/bash"
            - "-lc"
          args:
            - |-
              set -euo pipefail

              : "${INIT_POSTGRES_HOST:?missing}"
              : "${INIT_POSTGRES_PORT:?missing}"
              : "${INIT_POSTGRES_DBNAME:?missing}"
              : "${INIT_POSTGRES_SUPER_USER:?missing}"
              : "${INIT_POSTGRES_SUPER_PASS:?missing}"

              echo "Host=${INIT_POSTGRES_HOST} Port=${INIT_POSTGRES_PORT} DB=${INIT_POSTGRES_DBNAME} SuperUser=${INIT_POSTGRES_SUPER_USER}"

              export PGPASSWORD="${INIT_POSTGRES_SUPER_PASS}"

              psql \
                -h "${INIT_POSTGRES_HOST}" \
                -p "${INIT_POSTGRES_PORT}" \
                -U "${INIT_POSTGRES_SUPER_USER}" \
                -d "${INIT_POSTGRES_DBNAME}" \
                -v ON_ERROR_STOP=1 \
                -c "CREATE EXTENSION IF NOT EXISTS vector CASCADE;" \
                -c "CREATE EXTENSION IF NOT EXISTS vchord CASCADE;" \
                -c "CREATE EXTENSION IF NOT EXISTS cube;" \
                -c "CREATE EXTENSION IF NOT EXISTS earthdistance;"
